# Deployment guide

## Overview

CodeMantle deploys as a split-plane system:

- `apps/control-plane` deployed to server/container infrastructure.
- `packages/agent-daemon` installed on managed hosts and connected outbound.
- `packages/codemantle` can act as a unified operator CLI wrapper for panel/agent setup and launch.
- `apps/desktop-app` shipped as an operator-facing desktop release artifact.

This topology preserves zero inbound host requirements while centralizing auth, orchestration, and audit policy.

## Environment setup

Control plane required variables:

- `VALID_TOKENS`: comma-separated daemon auth tokens.
- `CONTROL_PLANE_PORT`: WebSocket service port.
- `CONTROL_PLANE_API_PORT`: HTTP API port.
- `AUTH_MODE`: `local` (current production-ready mode), `disabled` (dev only), or future `oidc` stub.
- `AUTH_MFA_ENABLED`: enable/disable 2FA requirement logic.
- `AUTH_MFA_PROVIDER`: `authy` or `totp` (both RFC6238 flow).
- `AUTH_MFA_REQUIRE_FOR_ALL_USERS`: require configured 2FA passkey for every local user.
- `AUTH_OWNER_EMAIL` + `AUTH_OWNER_PASSWORD` (or `AUTH_OWNER_PASSWORD_HASH`): bootstrap owner identity.
- `AUTH_OWNER_2FA_PASSKEY` (recommended): Base32 RFC6238 passkey for owner MFA.
- `AUTH_OWNER_TOTP_SECRET` (legacy alias, optional).
- `AUTH_COOKIE_SECURE=true` for internet-exposed TLS deployments.

Agent daemon required variables:

- `CONTROL_PLANE_URL`: `ws://` or `wss://` control plane endpoint.
- `AGENT_AUTH_TOKEN`: token paired with control-plane `VALID_TOKENS`.

## Build and run

Control plane:

```bash
npm ci --prefix apps/control-plane
npm run build --prefix apps/control-plane
npm run start --prefix apps/control-plane
```

Control plane via npm package:

```bash
npx @codemantle/panel start
```

If `.env` is missing, the first run launches an interactive initializer and writes `.env`.

Headless init example:

```bash
npx @codemantle/panel init --non-interactive \
  --set AUTH_OWNER_EMAIL=owner@example.com \
  --set AUTH_OWNER_PASSWORD="change-me" \
  --set VALID_TOKENS="replace-with-secure-token"
```

Agent daemon:

```bash
npm ci --prefix packages/agent-daemon
npm run build --prefix packages/agent-daemon
npm run start --prefix packages/agent-daemon
```

Unified orchestrator:

```bash
npx codemantle --panel
npx codemantle --agent
```

Desktop app (web build):

```bash
npm ci --prefix apps/desktop-app
npm run build --prefix apps/desktop-app
```

Desktop app (native bundle, platform dependent):

```bash
npm run tauri:build --prefix apps/desktop-app
```

## Release artifacts

- Control plane: deployable Node artifact from `apps/control-plane/dist`.
- Agent daemon: packaged binaries from `packages/agent-daemon/bin` plus npm wrapper tarball (`npm pack`).
- Orchestrator CLI: npm package (`codemantle`) from `packages/codemantle` with `codemantle` command.
- Desktop app: signed/packaged installers generated by Tauri build workflow.

## Release automation

- All component release workflows trigger on semantic tags (`vX.Y.Z`) and support manual dispatch.
- Desktop workflow builds Windows NSIS (`.exe`) and macOS DMG (`.dmg`) artifacts.
- Agent workflow publishes release binaries (`codemantle-agent-<platform>-<arch>`), `checksums.txt`, and npm package artifact.
- Orchestrator workflow publishes npm package artifact for `codemantle`.

### Optional signing and updater secrets

- Desktop binary signing hooks are guarded and only run when signing secrets are present.
- Tauri updater signatures are provided via:
  - `TAURI_SIGNING_PRIVATE_KEY`
  - `TAURI_SIGNING_PRIVATE_KEY_PASSWORD`
- Binary signing hooks:
  - Windows: `WINDOWS_CERTIFICATE`, `WINDOWS_CERTIFICATE_PASSWORD`
  - macOS: `APPLE_CERTIFICATE`, `APPLE_CERTIFICATE_PASSWORD`, `APPLE_SIGNING_IDENTITY`, `APPLE_ID`, `APPLE_PASSWORD`, `APPLE_TEAM_ID`

## Operational guardrails

- Enforce TLS (`wss`) for production control-plane ingress.
- Rotate daemon auth tokens and keep short-lived JIT credentials.
- Scope control-plane API access per tenant/device ownership.

### 24/7 operation

PM2 (single-node baseline):

```bash
pm2 start "npx @codemantle/panel start --env-file /opt/codemantle/.env" --name codemantle-panel
pm2 save
pm2 startup
```

systemd (Linux baseline):

```ini
[Unit]
Description=CodeMantle Panel
After=network.target

[Service]
Type=simple
WorkingDirectory=/opt/codemantle
EnvironmentFile=/opt/codemantle/.env
ExecStart=/usr/bin/env npx @codemantle/panel start --env-file /opt/codemantle/.env --non-interactive
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

### Internet-exposed control-plane hardening baseline

- Place control-plane behind a reverse proxy (Nginx/Caddy/Traefik) with TLS termination and HSTS.
- Only expose 443 publicly; keep `CONTROL_PLANE_PORT` and `CONTROL_PLANE_API_PORT` restricted to private network or loopback behind proxy.
- Forward `X-Forwarded-For`/`X-Forwarded-Proto` consistently and enforce HTTPS redirect at edge.
- Keep host firewall default-deny for inbound except 443 (and SSH from trusted admin IPs).
- Enable local auth (`AUTH_MODE=local`) and enable MFA (`AUTH_MFA_ENABLED=true`) with owner passkey (`AUTH_OWNER_2FA_PASSKEY`) and per-user passkeys in `AUTH_LOCAL_USERS`.
